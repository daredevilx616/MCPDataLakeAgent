<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Analytics Agent</title>
    <style>
      :root {
        color-scheme: dark;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: #1f1f24;
        color: #f5f5f5;
        display: flex;
      }
      .nav-rail {
        width: 56px;
        background: #151518;
        border-right: 1px solid rgba(255, 255, 255, 0.04);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.75rem 0;
        gap: 0.5rem;
        position: sticky;
        top: 0;
        height: 100vh;
      }
      .nav-rail button {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        border: none;
        background: rgba(255, 255, 255, 0.06);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #d7defa;
        cursor: pointer;
        transition: background 0.15s ease;
      }
      .nav-rail button:hover {
        background: rgba(255, 255, 255, 0.12);
      }
      .app-shell {
        flex: 1;
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        width: 360px;
        background: rgba(28, 28, 34, 0.96);
        border-right: 1px solid rgba(255, 255, 255, 0.05);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        transition: width 0.25s ease, padding 0.25s ease, opacity 0.25s ease;
        overflow-y: auto;
        position: sticky;
        top: 0;
        height: 100vh;
      }
      .sidebar.collapsed {
        width: 0;
        padding: 0;
        opacity: 0;
        pointer-events: none;
        border-right: none;
      }
      .sidebar h2 {
        margin: 0;
        font-size: 1.3rem;
      }
      .sidebar p {
        margin: 0;
        color: #9da9cc;
        font-size: 0.95rem;
      }
      select,
      input,
      textarea,
      pre {
        width: 100%;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(15, 23, 42, 0.6);
        color: #f8fbff;
        font-size: 0.95rem;
        padding: 0.65rem 0.8rem;
      }
      label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #6ea8ff;
      }
      .connector-card {
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 14px;
        padding: 1rem;
        background: rgba(10, 15, 30, 0.75);
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
      }
      .connector-card header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
      }
      .connector-card h3 {
        margin: 0;
        font-size: 1rem;
      }
      .connector-card button {
        border: none;
        border-radius: 999px;
        padding: 0.4rem 0.9rem;
        background: linear-gradient(120deg, #5a7bff, #4dd3ff);
        color: #05070e;
        font-weight: 600;
        cursor: pointer;
      }
      .sidebar small {
        color: #ff9b8a;
      }
      details.connector-card summary {
        list-style: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }
      details.connector-card summary::-webkit-details-marker {
        display: none;
      }
      details.connector-card summary h3 {
        margin: 0;
      }
      .chat-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 0;
        gap: 1.5rem;
      }
      .chat-panel header {
        position: sticky;
        top: 0;
        z-index: 5;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 1.5rem 2rem;
        background: rgba(31, 31, 36, 0.98);
        backdrop-filter: blur(6px);
      }
      .chat-panel h1 {
        margin: 0;
        font-size: 1.8rem;
      }
      .chat-log {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: 0 2rem 0 2rem;
      }
      .message {
        max-width: 80%;
        display: flex;
      }
      .message.system {
        align-self: center;
        max-width: 100%;
      }
      .message.user {
        justify-content: flex-end;
        align-self: flex-end;
      }
      .message.bot {
        align-self: flex-start;
      }
      .bubble {
        background: rgba(31, 41, 70, 0.75);
        border-radius: 18px;
        padding: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
        width: fit-content;
      }
      .message.user .bubble {
        background: linear-gradient(120deg, #2563eb, #9333ea);
        color: #f0f4ff;
      }
      .message.system .bubble {
        background: rgba(255, 255, 255, 0.05);
        color: #cdd8ff;
      }
      .bubble pre {
        margin-top: 0.75rem;
        background: rgba(9, 14, 26, 0.85);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.75rem;
      }
      th,
      td {
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 0.5rem;
        font-size: 0.85rem;
      }
      .composer {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        padding: 1rem 2rem 2rem;
        position: sticky;
        bottom: 0;
        background: rgba(31, 31, 36, 0.95);
        backdrop-filter: blur(6px);
      }
      .composer textarea {
        flex: 1;
        min-height: 70px;
      }
      .composer button {
        border: none;
        border-radius: 999px;
        height: 44px;
        padding: 0 1.5rem;
        background: linear-gradient(120deg, #5a7bff, #4dd3ff);
        color: #05070e;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
      }
      @media (max-width: 1100px) {
        body {
          flex-direction: column;
        }
        .nav-rail {
          flex-direction: row;
          width: 100%;
          justify-content: center;
        }
        .app-shell {
          flex-direction: column;
        }
        .sidebar {
          width: 100%;
          transform: none !important;
          border-right: none;
          border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .chat-panel {
          padding: 1.5rem;
        }
        .message {
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <nav class="nav-rail">
      <button title="Toggle connectors" id="toggle-sidebar">â˜°</button>
    </nav>
    <div class="app-shell" id="app-shell">
      <aside class="sidebar" id="connector-panel">
        <div>
          <h2>Database Connectors</h2>
          <p>Configure multiple backends for the MCP agent.</p>
        </div>
        <div>
          <label for="active-db">Active Database</label>
          <select id="active-db">
            <option value="sqlite">SQLite</option>
            <option value="postgresql">PostgreSQL</option>
            <option value="mysql">MySQL</option>
            <option value="mssql">MS SQL Server</option>
            <option value="mongodb">MongoDB</option>
          </select>
        </div>
        <details class="connector-card" open>
          <summary>
            <h3>SQLite</h3>
            <button type="button" class="connector-save" data-target="sqlite">Save</button>
          </summary>
          <label for="sqlite-path">Database Path</label>
          <input id="sqlite-path" type="text" placeholder="./data/sales.db" />
        </details>
        <details class="connector-card">
          <summary>
            <h3>PostgreSQL</h3>
            <button type="button" class="connector-save" data-target="postgresql">Save</button>
          </summary>
          <label for="pg-host">Host</label>
          <input id="pg-host" type="text" placeholder="localhost" />
          <label for="pg-port">Port</label>
          <input id="pg-port" type="text" placeholder="5432" />
          <label for="pg-database">Database</label>
          <input id="pg-database" type="text" />
          <label for="pg-username">Username</label>
          <input id="pg-username" type="text" />
          <label for="pg-password">Password</label>
          <input id="pg-password" type="password" />
        </details>
        <details class="connector-card">
          <summary>
            <h3>MySQL</h3>
            <button type="button" class="connector-save" data-target="mysql">Save</button>
          </summary>
          <label for="mysql-host">Host</label>
          <input id="mysql-host" type="text" placeholder="localhost" />
          <label for="mysql-port">Port</label>
          <input id="mysql-port" type="text" placeholder="3306" />
          <label for="mysql-database">Database</label>
          <input id="mysql-database" type="text" />
          <label for="mysql-username">Username</label>
          <input id="mysql-username" type="text" />
          <label for="mysql-password">Password</label>
          <input id="mysql-password" type="password" />
        </details>
        <details class="connector-card">
          <summary>
            <h3>MS SQL Server</h3>
            <button type="button" class="connector-save" data-target="mssql">Save</button>
          </summary>
          <label for="mssql-server">Server</label>
          <input id="mssql-server" type="text" placeholder="your_server_name" />
          <label for="mssql-database">Database</label>
          <input id="mssql-database" type="text" placeholder="your_database_name" />
          <label for="mssql-username">Username</label>
          <input id="mssql-username" type="text" placeholder="your_username" />
          <label for="mssql-password">Password</label>
          <input id="mssql-password" type="password" placeholder="your_password" />
        </details>
        <details class="connector-card">
          <summary>
            <h3>MongoDB</h3>
            <button type="button" class="connector-save" data-target="mongodb">Save</button>
          </summary>
          <label for="mongo-uri">Connection URI</label>
          <input id="mongo-uri" type="text" placeholder="mongodb+srv://..." />
          <label for="mongo-database">Database</label>
          <input id="mongo-database" type="text" />
          <label for="mongo-collection">Collection</label>
          <input id="mongo-collection" type="text" />
        </details>
        <small id="connector-status"></small>
      </aside>
      <main class="chat-panel">
        <header>
          <div>
            <h1>Analytics Copilot</h1>
            <p style="margin: 0; color: #94a3c9;">Chat with your governed data lake.</p>
          </div>
        </header>
        <div class="chat-log" id="chat-log"></div>
        <div class="composer">
          <textarea id="chat-input" placeholder="Ask about revenue, customers, payments..."></textarea>
          <button id="send-button">Send</button>
        </div>
      </main>
    </div>
    <script>
      const connectorPanel = document.getElementById('connector-panel');
      const toggleSidebarButton = document.getElementById('toggle-sidebar');
      const connectorStatus = document.getElementById('connector-status');
      const connectorButtons = document.querySelectorAll('.connector-save');
      const activeDbSelect = document.getElementById('active-db');

      const connectorInputs = {
        sqlite: {
          path: document.getElementById('sqlite-path'),
        },
        postgresql: {
          host: document.getElementById('pg-host'),
          port: document.getElementById('pg-port'),
          database: document.getElementById('pg-database'),
          username: document.getElementById('pg-username'),
          password: document.getElementById('pg-password'),
        },
        mysql: {
          host: document.getElementById('mysql-host'),
          port: document.getElementById('mysql-port'),
          database: document.getElementById('mysql-database'),
          username: document.getElementById('mysql-username'),
          password: document.getElementById('mysql-password'),
        },
        mssql: {
          server: document.getElementById('mssql-server'),
          database: document.getElementById('mssql-database'),
          username: document.getElementById('mssql-username'),
          password: document.getElementById('mssql-password'),
        },
        mongodb: {
          uri: document.getElementById('mongo-uri'),
          database: document.getElementById('mongo-database'),
          collection: document.getElementById('mongo-collection'),
        },
      };

      const readConnectorPayload = () => {
        const payload = { active: activeDbSelect.value };
        Object.entries(connectorInputs).forEach(([key, fields]) => {
          payload[key] = {};
          Object.entries(fields).forEach(([field, input]) => {
            payload[key][field] = input.value.trim();
          });
        });
        return payload;
      };

      const populateConnectorForm = (data) => {
        if (!data) return;
        activeDbSelect.value = data.active || 'sqlite';
        Object.entries(connectorInputs).forEach(([key, fields]) => {
          const section = data[key] || {};
          Object.entries(fields).forEach(([field, input]) => {
            input.value = section[field] || '';
          });
        });
      };

      const fetchConnectors = async () => {
        connectorStatus.textContent = 'Loading connectors...';
        connectorStatus.style.color = '#80ffea';
        try {
          const res = await fetch('/api/connectors');
          const payload = await res.json();
          if (!res.ok) throw new Error(payload.error || 'Unable to load connectors');
          populateConnectorForm(payload);
          connectorStatus.textContent = 'Connectors loaded';
          connectorStatus.style.color = '#80ffea';
        } catch (error) {
          connectorStatus.textContent = error.message;
          connectorStatus.style.color = '#ff8585';
        }
      };

      const saveConnectors = async () => {
        connectorStatus.textContent = 'Saving connectors...';
        connectorStatus.style.color = '#80ffea';
        try {
          const res = await fetch('/api/connectors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(readConnectorPayload()),
          });
          const payload = await res.json();
          if (!res.ok) throw new Error(payload.error || 'Unable to save connectors');
          populateConnectorForm(payload);
          connectorStatus.textContent = 'Connector settings saved';
          connectorStatus.style.color = '#a0f0c6';
        } catch (error) {
          connectorStatus.textContent = error.message;
          connectorStatus.style.color = '#ff8585';
        }
      };

      connectorButtons.forEach((button) => {
        button.addEventListener('click', saveConnectors);
      });
      toggleSidebarButton.addEventListener('click', () => {
        connectorPanel.classList.toggle('collapsed');
      });

      const chatLog = document.getElementById('chat-log');
      const chatInput = document.getElementById('chat-input');
      const sendButton = document.getElementById('send-button');

      const scrollChatToBottom = () => {
        requestAnimationFrame(() => {
          chatLog.scrollTop = chatLog.scrollHeight;
        });
      };

      const renderTableElement = (rows = []) => {
        if (!rows.length) {
          const empty = document.createElement('p');
          empty.textContent = '(no rows returned)';
          empty.style.color = '#a5b4d6';
          return empty;
        }
        const columns = Object.keys(rows[0]);
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        columns.forEach((col) => {
          const th = document.createElement('th');
          th.textContent = col;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        const tbody = document.createElement('tbody');
        rows.forEach((row) => {
          const tr = document.createElement('tr');
          columns.forEach((col) => {
            const td = document.createElement('td');
            td.textContent = row[col];
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(thead);
        table.appendChild(tbody);
        return table;
      };

      const appendSystemMessage = (text) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'message system';
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.textContent = text;
        wrapper.appendChild(bubble);
        chatLog.appendChild(wrapper);
        scrollChatToBottom();
      };

      const appendUserMessage = (text) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'message user';
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.textContent = text;
        wrapper.appendChild(bubble);
        chatLog.appendChild(wrapper);
        scrollChatToBottom();
      };

      const appendAgentMessage = (payload) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'message bot';
        const bubble = document.createElement('div');
        bubble.className = 'bubble';

        const rationale = document.createElement('p');
        rationale.style.marginTop = '0';
        rationale.style.marginBottom = '0.5rem';
        rationale.textContent = payload.rationale || 'No rationale provided.';
        bubble.appendChild(rationale);

        const sqlLabel = document.createElement('strong');
        sqlLabel.textContent = 'Generated SQL';
        bubble.appendChild(sqlLabel);

        const sqlBlock = document.createElement('pre');
        sqlBlock.textContent = payload.sql || '(missing sql)';
        bubble.appendChild(sqlBlock);

        const resultSets = payload.result_sets && payload.result_sets.length
          ? payload.result_sets
          : [{
            statement: payload.sql,
            rows: payload.rows || [],
            row_count: payload.row_count ?? (Array.isArray(payload.rows) ? payload.rows.length : 0),
          }];

        resultSets.forEach((set, idx) => {
          const rowsLabel = document.createElement('strong');
          rowsLabel.textContent = `Result ${idx + 1} (${set.row_count ?? (set.rows?.length || 0)} rows)`;
          bubble.appendChild(rowsLabel);
          const stmtPre = document.createElement('pre');
          stmtPre.textContent = set.statement;
          bubble.appendChild(stmtPre);
          bubble.appendChild(renderTableElement(set.rows || []));
        });

        wrapper.appendChild(bubble);
        chatLog.appendChild(wrapper);
        scrollChatToBottom();
      };

      const appendErrorMessage = (text) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'message bot';
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.style.background = 'rgba(127, 29, 29, 0.7)';
        bubble.style.border = '1px solid rgba(248, 113, 113, 0.4)';
        bubble.textContent = text;
        wrapper.appendChild(bubble);
        chatLog.appendChild(wrapper);
        scrollChatToBottom();
      };

      const sendQuestion = async () => {
        const question = chatInput.value.trim();
        if (!question) {
          chatInput.focus();
          return;
        }
        appendUserMessage(question);
        chatInput.value = '';
        chatInput.disabled = true;
        sendButton.disabled = true;
        try {
          const response = await fetch('/api/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question }),
          });
          const payload = await response.json();
          if (!response.ok) {
            throw new Error(payload.error || 'Unknown error');
          }
          appendAgentMessage(payload);
        } catch (error) {
          appendErrorMessage(error.message);
        } finally {
          chatInput.disabled = false;
          sendButton.disabled = false;
          chatInput.focus();
        }
      };

      sendButton.addEventListener('click', sendQuestion);
      chatInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          sendQuestion();
        }
      });

      appendSystemMessage('Ready to analyze the database? Configure connectors and ask questions.');
      fetchConnectors();
    </script>
  </body>
</html>
